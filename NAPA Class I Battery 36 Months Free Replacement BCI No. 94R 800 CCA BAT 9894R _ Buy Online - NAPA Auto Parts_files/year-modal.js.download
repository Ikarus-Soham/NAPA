var YearModal=function(){var $year=$("#year-modal-selection");var vehYear={};var destURL={};var fitmentDialog;var yearData;var vehMakeId;var vehModelId;var vehTypeId;var vehMakeName;var vehModelName;var vehTypeName;var wireEvents=function(){yearData={};$.ajax({url:$("#yearsUrl").text(),type:"GET",success:function(data){if(data.status=="success"){$.each(JSON.parse(data.resultData).RefinementGroups.RefinementGroupArray,function(){if(this.RefinementName==$("#yearLocalized").text()){$.each(this.Refinements,function(){yearData[this.RefinementText]=this.RefinementValue;});var yearKeys=Object.keys(yearData);yearKeys.sort().reverse();$("#year-modal-selection").typeahead({hint:true,highlight:true,minLength:0},{name:"years",source:substringMatcher(yearKeys),limit:Infinity});}});}}});$(".year-fitment-saved-button").on("click",setNewVehicle);wireModal();};var showModal=function(e){var configuration={otherClose:".fitment-modal-close",beforeOpen:function(e){if(AAData){merge(AAData,{page:{pageName:"all products",channel:"search",template:"modal"}});try{if(_satellite){_satellite.track("search_modal");}}catch(e){}}},beforeContent:function(){$(this.$instance).find(".featherlight-close").remove();$(this.$instance).find(".featherlight-content").css("border-bottom","none");$(this.$instance).find(".featherlight-content").css("overflow","visible");$("body").addClass("stuck");$(".modal-year-only").css("border","none");},afterClose:function(){$("body").removeClass("stuck");},persist:true};if(!fitmentDialog){fitmentDialog=$.featherlight($("#modalYearAdd"),configuration);}else{fitmentDialog.open();}$year.on("focus",function(e){var temp=$year[0].value;$year.typeahead("val","");$year[0].value=temp;$year[0].setSelectionRange(0,9999);isSelected=false;});setTimeout(function(){$year.focus();},500);};var wireModal=function(){$(document).on("click",".add-new-year",function(e){destURL=$(this).attr("data-url");e.preventDefault();showModal(e);});};var setNewVehicle=function(){vehYear.RefinementText=$("#year-modal-selection").val();vehYear.RefinementValue=yearData[vehYear.RefinementText];if(!vehYear.RefinementValue){$(".modal-year-only").css("border","2px #ff4242 solid");return false;}var formdata={vehicleTypeId:vehTypeId,vehicleType:vehTypeName,yearId:vehYear.RefinementValue,year:vehYear.RefinementText,makeId:vehMakeId,make:vehMakeName,modelId:vehModelId,model:vehModelName,referrer:"yearModal",CSRFToken:ACC.config.CSRFToken};var makeId=formdata.modelId.substr(1,4);formdata.makeId="5"+makeId+"00";$.ajax({url:"/my-vehicle/add-vehicle/",type:"POST",data:$.param(formdata),success:function(data){if(data.status=="success"){var btnSaved=$(".year-fitment-saved-button");btnSaved.addClass("disabled-button");refreshOrSearch();}}});return true;};var refreshOrSearch=function(){$(document).unbind("ajaxStop");$(document).ajaxStop(function(){$(".ajax-loader").show();$(".ajax-loader").attr("aria-busy","true");});if(vehYear.RefinementText!=null||vehYear.RefinementText!=""){destURL=destURL+"&year="+vehYear.RefinementText;}window.location.href=destURL;};var _init=function(){vehMakeId=$("#makeElement").attr("data-id");vehModelId=$("#modelElement").attr("data-id");vehTypeId=$("#vehTypeElement").attr("data-id");vehMakeName=$("#makeElement").attr("data-name");vehModelName=$("#modelElement").attr("data-name");vehTypeName=$("#vehTypeElement").attr("data-name");if($("#yearsUrl").length!=0){wireEvents();}};var substringMatcher=function(strs){return function findMatches(q,cb){var matches,substringRegex;matches=[];substrRegex=new RegExp(q,"i");$.each(strs,function(i,str){if(substrRegex.test(str)){matches.push(str);}});cb(matches);};};return{init:_init};}();$(document).ready(function(){YearModal.init();});